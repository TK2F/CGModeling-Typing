<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CG„É¢„Éá„É™„É≥„Ç∞ „Çø„Ç§„Éî„É≥„Ç∞„Ç≤„Éº„É† NEO - Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        
        * {
            font-family: 'Noto Sans JP', sans-serif;
        }
        
        .game-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }
        
        .word-falling {
            animation: fall linear infinite;
        }
        
        @keyframes fall {
            from { transform: translateY(-100px); }
            to { transform: translateY(100vh); }
        }
        
        .particle {
            position: absolute;
            pointer-events: none;
            animation: particle-burst 1s ease-out forwards;
        }
        
        @keyframes particle-burst {
            0% { transform: scale(1) translate(0, 0); opacity: 1; }
            100% { transform: scale(0.5) translate(var(--dx), var(--dy)); opacity: 0; }
        }
        
        .combo-pulse {
            animation: combo-pulse 0.3s ease-in-out;
        }
        
        @keyframes combo-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .flick-key {
            position: relative;
            transition: all 0.15s ease;
        }
        
        .flick-key:active {
            transform: scale(0.95);
            background-color: rgba(59, 130, 246, 0.3);
        }
        
        .flick-hints {
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .flick-key:active .flick-hints {
            opacity: 1;
        }
        
        .stats-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #10b981 0%, #3b82f6 50%, #8b5cf6 100%);
            animation: progress-glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes progress-glow {
            0% { filter: brightness(1); }
            100% { filter: brightness(1.2); }
        }
        
        .achievement-badge {
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            animation: achievement-glow 1s ease-in-out infinite alternate;
        }
        
        @keyframes achievement-glow {
            0% { box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
            100% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.8); }
        }
        
        .screen-shake {
            animation: screen-shake 0.3s ease-in-out;
        }
        
        @keyframes screen-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @media (max-width: 768px) {
            .mobile-optimized {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body class="game-gradient min-h-screen overflow-hidden select-none">
    <!-- „Ç≤„Éº„É†ÂÖ®‰Ωì„ÅÆ„Ç≥„É≥„ÉÜ„Éä -->
    <div id="gameContainer" class="relative w-full h-screen overflow-hidden">
        
        <!-- „É°„Ç§„É≥„É°„Éã„É•„ÉºÁîªÈù¢ -->
        <div id="menuScreen" class="absolute inset-0 flex flex-col items-center justify-center">
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-6xl font-bold text-white mb-4 drop-shadow-lg">
                    CG„É¢„Éá„É™„É≥„Ç∞
                </h1>
                <h2 class="text-2xl md:text-4xl font-medium text-white/90 mb-2">
                    „Çø„Ç§„Éî„É≥„Ç∞„Ç≤„Éº„É† NEO
                </h2>
                <p class="text-lg text-white/80 font-light">Ultimate Edition v4.0</p>
            </div>
            
            <!-- ÁèæÂú®„ÅÆË®≠ÂÆöË°®Á§∫ -->
            <div class="stats-card rounded-lg p-4 mb-6 text-white text-center">
                <p class="text-sm opacity-90">
                    <span id="currentMode">„Ç´„Çø„Ç´„Éä</span> / 
                    <span id="currentDifficulty">„Åµ„Å§„ÅÜ</span>
                </p>
            </div>
            
            <!-- „É°„Éã„É•„Éº„Éú„Çø„É≥ -->
            <div class="flex flex-col gap-4 w-80 max-w-full px-4">
                <button id="startGame" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg">
                    „Ç≤„Éº„É†„Çπ„Çø„Éº„Éà
                </button>
                <button id="tutorialBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg">
                    „ÉÅ„É•„Éº„Éà„É™„Ç¢„É´
                </button>
                <button id="settingsBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg">
                    Ë®≠ÂÆö
                </button>
                <button id="statisticsBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg">
                    Áµ±Ë®à„ÉªÂ±•Ê≠¥
                </button>
            </div>
        </div>
        
        <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
        <div id="gameScreen" class="absolute inset-0 hidden">
            <!-- „Ç≤„Éº„É†‰∏äÈÉ®UI -->
            <div class="absolute top-0 left-0 right-0 z-10 p-4">
                <div class="flex justify-between items-start">
                    <!-- Â∑¶ÂÅ¥Ôºö„Çπ„Ç≥„Ç¢„ÄÅ„Ç≥„É≥„Éú -->
                    <div class="stats-card rounded-lg p-3 text-white">
                        <div class="text-sm opacity-90">Score</div>
                        <div id="score" class="text-2xl font-bold">0</div>
                        <div id="combo" class="text-sm mt-1 hidden">
                            Combo: <span class="font-bold text-yellow-300">0</span>x
                        </div>
                    </div>
                    
                    <!-- Âè≥ÂÅ¥Ôºö„Çø„Ç§„Éû„Éº„ÄÅ„Éù„Éº„Ç∫ -->
                    <div class="flex items-center gap-3">
                        <div class="stats-card rounded-lg p-3 text-white text-center">
                            <div class="text-sm opacity-90">Time</div>
                            <div id="timeLeft" class="text-2xl font-bold">60</div>
                        </div>
                        <button id="pauseBtn" class="bg-white/20 hover:bg-white/30 text-white p-3 rounded-lg transition-all">
                            ‚è∏Ô∏è
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ËêΩ‰∏ãÂçòË™û„Ç®„É™„Ç¢ -->
            <div id="wordsContainer" class="absolute inset-0 pointer-events-none"></div>
            
            <!-- „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Ç®„Éï„Çß„ÇØ„Éà„Ç≥„É≥„ÉÜ„Éä -->
            <div id="particlesContainer" class="absolute inset-0 pointer-events-none"></div>
            
            <!-- ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
            <div class="absolute bottom-0 left-0 right-0 p-4">
                <!-- ÁèæÂú®„ÅÆÂÖ•ÂäõË°®Á§∫ -->
                <div class="stats-card rounded-lg p-4 mb-4 text-center">
                    <div class="text-white text-lg mb-2">ÂÖ•Âäõ‰∏≠:</div>
                    <div id="currentInput" class="text-2xl font-mono bg-black/30 rounded px-4 py-2 text-white min-h-[40px]"></div>
                </div>
                
                <!-- ÂÖ•Âäõ„É¢„Éº„ÉâÂàáÊõø -->
                <div class="flex justify-center gap-2 mb-4">
                    <button id="toggleInput" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-all">
                        <span id="inputModeText">„Éï„É™„ÉÉ„ÇØÂÖ•Âäõ</span>„Å´ÂàáÊõø
                    </button>
                </div>
                
                <!-- „Ç≠„Éº„Éú„Éº„Éâ„Ç®„É™„Ç¢ -->
                <div id="keyboardContainer">
                    <!-- QWERTY „Ç≠„Éº„Éú„Éº„Éâ -->
                    <div id="qwertyKeyboard" class="grid grid-cols-10 gap-1 md:gap-2 max-w-4xl mx-auto"></div>
                    
                    <!-- „Éï„É™„ÉÉ„ÇØ „Ç≠„Éº„Éú„Éº„Éâ -->
                    <div id="flickKeyboard" class="hidden grid grid-cols-5 gap-2 max-w-xl mx-auto"></div>
                </div>
            </div>
        </div>
        
        <!-- Ë®≠ÂÆöÁîªÈù¢ -->
        <div id="settingsScreen" class="absolute inset-0 hidden flex flex-col items-center justify-center p-4">
            <div class="stats-card rounded-xl p-6 w-full max-w-md">
                <h2 class="text-2xl font-bold text-white mb-6 text-center">Ë®≠ÂÆö</h2>
                
                <!-- Ë°®Á§∫„É¢„Éº„ÉâË®≠ÂÆö -->
                <div class="mb-6">
                    <h3 class="text-white font-semibold mb-3">Ë°®Á§∫„É¢„Éº„Éâ</h3>
                    <div class="grid grid-cols-1 gap-2">
                        <button class="mode-btn bg-white/20 hover:bg-white/30 text-white py-2 px-4 rounded-lg transition-all" data-mode="katakana">„Ç´„Çø„Ç´„Éä„É¢„Éº„Éâ</button>
                        <button class="mode-btn bg-white/20 hover:bg-white/30 text-white py-2 px-4 rounded-lg transition-all" data-mode="hiragana">„Å≤„Çâ„Åå„Å™„É¢„Éº„Éâ</button>
                        <button class="mode-btn bg-white/20 hover:bg-white/30 text-white py-2 px-4 rounded-lg transition-all" data-mode="mixed">„Éü„ÉÉ„ÇØ„Çπ„É¢„Éº„Éâ</button>
                    </div>
                </div>
                
                <!-- Èõ£ÊòìÂ∫¶Ë®≠ÂÆö -->
                <div class="mb-6">
                    <h3 class="text-white font-semibold mb-3">Èõ£ÊòìÂ∫¶</h3>
                    <div class="grid grid-cols-1 gap-2">
                        <button class="difficulty-btn bg-white/20 hover:bg-white/30 text-white py-2 px-4 rounded-lg transition-all" data-difficulty="easy">„Åã„Çì„Åü„Çì (90Áßí)</button>
                        <button class="difficulty-btn bg-white/20 hover:bg-white/30 text-white py-2 px-4 rounded-lg transition-all" data-difficulty="normal">„Åµ„Å§„ÅÜ (60Áßí)</button>
                        <button class="difficulty-btn bg-white/20 hover:bg-white/30 text-white py-2 px-4 rounded-lg transition-all" data-difficulty="hard">„ÇÄ„Åö„Åã„Åó„ÅÑ (45Áßí)</button>
                    </div>
                </div>
                
                <!-- „Çµ„Ç¶„É≥„ÉâË®≠ÂÆö -->
                <div class="mb-6">
                    <label class="flex items-center justify-between text-white">
                        <span>„Çµ„Ç¶„É≥„Éâ</span>
                        <input type="checkbox" id="soundToggle" class="toggle" checked>
                    </label>
                </div>
                
                <button id="backToMenu" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg transition-all">
                    „É°„Éã„É•„Éº„Å´Êàª„Çã
                </button>
            </div>
        </div>
        
        <!-- Áµ±Ë®àÁîªÈù¢ -->
        <div id="statisticsScreen" class="absolute inset-0 hidden overflow-y-auto p-4">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-white">Áµ±Ë®à„ÉªÂ±•Ê≠¥</h2>
                    <button id="backToMenuFromStats" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all">
                        Êàª„Çã
                    </button>
                </div>
                
                <!-- Á∑èÂêàÁµ±Ë®à -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="stats-card rounded-lg p-4 text-center">
                        <div class="text-white/80 text-sm">Á∑è„Éó„É¨„Ç§ÂõûÊï∞</div>
                        <div id="totalGames" class="text-2xl font-bold text-white">0</div>
                    </div>
                    <div class="stats-card rounded-lg p-4 text-center">
                        <div class="text-white/80 text-sm">ÊúÄÈ´ò„Çπ„Ç≥„Ç¢</div>
                        <div id="bestScore" class="text-2xl font-bold text-yellow-300">0</div>
                    </div>
                    <div class="stats-card rounded-lg p-4 text-center">
                        <div class="text-white/80 text-sm">Âπ≥ÂùáWPM</div>
                        <div id="averageWPM" class="text-2xl font-bold text-green-300">0</div>
                    </div>
                </div>
                
                <!-- „É¨„Éô„É´ÈÄ≤Ë°åÁä∂Ê≥Å -->
                <div class="stats-card rounded-lg p-4 mb-6">
                    <h3 class="text-white font-semibold mb-3">„É¨„Éô„É´ÈÄ≤Ë°åÁä∂Ê≥Å</h3>
                    <div class="flex items-center gap-4">
                        <div class="text-white text-xl font-bold">Lv.<span id="currentLevel">1</span></div>
                        <div class="flex-1">
                            <div class="bg-black/30 rounded-full h-4 overflow-hidden">
                                <div id="levelProgress" class="progress-bar h-full rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="text-white/80 text-sm">
                            <span id="currentXP">0</span>/<span id="nextLevelXP">100</span> XP
                        </div>
                    </div>
                </div>
                
                <!-- ÈÅîÊàêË®òÈå≤ -->
                <div class="stats-card rounded-lg p-4 mb-6">
                    <h3 class="text-white font-semibold mb-3">ÈÅîÊàêË®òÈå≤</h3>
                    <div id="achievements" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <!-- ÈÅîÊàêË®òÈå≤„Åå„Åì„Åì„Å´ÂãïÁöÑËøΩÂä†„Åï„Çå„Çã -->
                    </div>
                </div>
                
                <!-- ÊúÄËøë„ÅÆ„Ç≤„Éº„É†Â±•Ê≠¥ -->
                <div class="stats-card rounded-lg p-4">
                    <h3 class="text-white font-semibold mb-3">ÊúÄËøë„ÅÆ„Ç≤„Éº„É†Â±•Ê≠¥</h3>
                    <div id="recentGames" class="space-y-2">
                        <!-- „Ç≤„Éº„É†Â±•Ê≠¥„Åå„Åì„Åì„Å´ÂãïÁöÑËøΩÂä†„Åï„Çå„Çã -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ÁµêÊûúÁîªÈù¢ -->
        <div id="resultsScreen" class="absolute inset-0 hidden flex flex-col items-center justify-center p-4">
            <div class="stats-card rounded-xl p-6 w-full max-w-lg text-center">
                <h2 class="text-3xl font-bold text-white mb-6">„Ç≤„Éº„É†ÁµêÊûú</h2>
                
                <!-- Áç≤ÂæóXPË°®Á§∫ -->
                <div id="xpGained" class="achievement-badge text-white font-bold py-2 px-4 rounded-lg mb-4 hidden">
                    <span>XP +</span><span id="xpAmount">0</span>
                </div>
                
                <!-- „Çπ„Ç≥„Ç¢Ë°®Á§∫ -->
                <div class="text-4xl font-bold text-yellow-300 mb-4">
                    <span id="finalScore">0</span> pt
                </div>
                
                <!-- Ë©≥Á¥∞Áµ±Ë®à -->
                <div class="grid grid-cols-2 gap-4 mb-6 text-white">
                    <div>
                        <div class="text-sm opacity-80">ÂÖ•ÂäõÂçòË™ûÊï∞</div>
                        <div id="finalWords" class="text-xl font-bold">0</div>
                    </div>
                    <div>
                        <div class="text-sm opacity-80">ÊúÄÂ§ß„Ç≥„É≥„Éú</div>
                        <div id="finalCombo" class="text-xl font-bold">0</div>
                    </div>
                    <div>
                        <div class="text-sm opacity-80">WPM</div>
                        <div id="finalWPM" class="text-xl font-bold">0</div>
                    </div>
                    <div>
                        <div class="text-sm opacity-80">Ê≠£Á¢∫ÊÄß</div>
                        <div id="finalAccuracy" class="text-xl font-bold">0%</div>
                    </div>
                </div>
                
                <!-- Êñ∞Ë®òÈå≤Ë°®Á§∫ -->
                <div id="newRecord" class="achievement-badge text-white font-bold py-2 px-4 rounded-lg mb-4 hidden">
                    üèÜ Êñ∞Ë®òÈå≤ÈÅîÊàêÔºÅ
                </div>
                
                <!-- „É¨„Éô„É´„Ç¢„ÉÉ„ÉóË°®Á§∫ -->
                <div id="levelUp" class="achievement-badge text-white font-bold py-2 px-4 rounded-lg mb-6 hidden">
                    üéâ „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ Lv.<span id="newLevel">2</span>
                </div>
                
                <!-- „Éú„Çø„É≥ -->
                <div class="flex flex-col gap-3">
                    <button id="playAgain" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg transition-all">
                        „ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§
                    </button>
                    <button id="backToMenuFromResults" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg transition-all">
                        „É°„Éã„É•„Éº„Å´Êàª„Çã
                    </button>
                </div>
            </div>
        </div>
        
        <!-- „ÉÅ„É•„Éº„Éà„É™„Ç¢„É´ÁîªÈù¢ -->
        <div id="tutorialScreen" class="absolute inset-0 hidden flex flex-col items-center justify-center p-4">
            <div class="stats-card rounded-xl p-6 w-full max-w-2xl">
                <h2 class="text-2xl font-bold text-white mb-6 text-center">„ÉÅ„É•„Éº„Éà„É™„Ç¢„É´</h2>
                
                <div id="tutorialContent" class="text-white space-y-4 mb-6">
                    <!-- „ÉÅ„É•„Éº„Éà„É™„Ç¢„É´ÂÜÖÂÆπ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                </div>
                
                <div class="flex justify-between">
                    <button id="tutorialPrev" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all">
                        Ââç„Å∏
                    </button>
                    <div class="flex items-center gap-2">
                        <span id="tutorialStep" class="text-white">1 / 4</span>
                    </div>
                    <button id="tutorialNext" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-all">
                        Ê¨°„Å∏
                    </button>
                </div>
            </div>
        </div>
        
        <!-- „Éù„Éº„Ç∫ÁîªÈù¢ -->
        <div id="pauseScreen" class="absolute inset-0 hidden flex flex-col items-center justify-center bg-black/50">
            <div class="stats-card rounded-xl p-6 text-center">
                <h2 class="text-2xl font-bold text-white mb-6">„Éù„Éº„Ç∫‰∏≠</h2>
                <div class="flex flex-col gap-3">
                    <button id="resumeGame" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg transition-all">
                        „Ç≤„Éº„É†ÂÜçÈñã
                    </button>
                    <button id="restartGame" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-lg transition-all">
                        „É™„Çπ„Çø„Éº„Éà
                    </button>
                    <button id="quitGame" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-lg transition-all">
                        „É°„Éã„É•„Éº„Å´Êàª„Çã
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== „Ç≤„Éº„É†Ë®≠ÂÆö„Å®„Éá„Éº„Çø =====
        const GAME_CONFIG = {
            durations: { easy: 90, normal: 60, hard: 45 },
            fallSpeeds: { easy: 3, normal: 4, hard: 5 },
            spawnIntervals: { easy: 3000, normal: 2000, hard: 1500 },
            version: 'v4.0.0 Ultimate Edition'
        };

        // „Ç´„ÉäÊñáÂ≠ó‚Üí„É≠„Éº„ÉûÂ≠óÂ§âÊèõ„Éû„ÉÉ„Éó
        const kanaToRomaji = {
            '„ÅÇ': 'a', '„ÅÑ': 'i', '„ÅÜ': 'u', '„Åà': 'e', '„Åä': 'o',
            '„Åã': 'ka', '„Åç': 'ki', '„Åè': 'ku', '„Åë': 'ke', '„Åì': 'ko',
            '„Åï': 'sa', '„Åó': 'shi', '„Åô': 'su', '„Åõ': 'se', '„Åù': 'so',
            '„Åü': 'ta', '„Å°': 'chi', '„Å§': 'tsu', '„Å¶': 'te', '„Å®': 'to',
            '„Å™': 'na', '„Å´': 'ni', '„Å¨': 'nu', '„Å≠': 'ne', '„ÅÆ': 'no',
            '„ÅØ': 'ha', '„Å≤': 'hi', '„Åµ': 'fu', '„Å∏': 'he', '„Åª': 'ho',
            '„Åæ': 'ma', '„Åø': 'mi', '„ÇÄ': 'mu', '„ÇÅ': 'me', '„ÇÇ': 'mo',
            '„ÇÑ': 'ya', '„ÇÜ': 'yu', '„Çà': 'yo',
            '„Çâ': 'ra', '„Çä': 'ri', '„Çã': 'ru', '„Çå': 're', '„Çç': 'ro',
            '„Çè': 'wa', '„Çí': 'wo', '„Çì': 'n',
            '„Åå': 'ga', '„Åé': 'gi', '„Åê': 'gu', '„Åí': 'ge', '„Åî': 'go',
            '„Åñ': 'za', '„Åò': 'ji', '„Åö': 'zu', '„Åú': 'ze', '„Åû': 'zo',
            '„Å†': 'da', '„Å¢': 'ji', '„Å•': 'zu', '„Åß': 'de', '„Å©': 'do',
            '„Å∞': 'ba', '„Å≥': 'bi', '„Å∂': 'bu', '„Åπ': 'be', '„Åº': 'bo',
            '„Å±': 'pa', '„Å¥': 'pi', '„Å∑': 'pu', '„Å∫': 'pe', '„ÅΩ': 'po',
            '„Åç„ÇÉ': 'kya', '„Åç„ÇÖ': 'kyu', '„Åç„Çá': 'kyo',
            '„Åó„ÇÉ': 'sha', '„Åó„ÇÖ': 'shu', '„Åó„Çá': 'sho',
            '„Å°„ÇÉ': 'cha', '„Å°„ÇÖ': 'chu', '„Å°„Çá': 'cho',
            '„Å´„ÇÉ': 'nya', '„Å´„ÇÖ': 'nyu', '„Å´„Çá': 'nyo',
            '„Å≤„ÇÉ': 'hya', '„Å≤„ÇÖ': 'hyu', '„Å≤„Çá': 'hyo',
            '„Åø„ÇÉ': 'mya', '„Åø„ÇÖ': 'myu', '„Åø„Çá': 'myo',
            '„Çä„ÇÉ': 'rya', '„Çä„ÇÖ': 'ryu', '„Çä„Çá': 'ryo',
            '„Åé„ÇÉ': 'gya', '„Åé„ÇÖ': 'gyu', '„Åé„Çá': 'gyo',
            '„Åò„ÇÉ': 'ja', '„Åò„ÇÖ': 'ju', '„Åò„Çá': 'jo',
            '„Å≥„ÇÉ': 'bya', '„Å≥„ÇÖ': 'byu', '„Å≥„Çá': 'byo',
            '„Å¥„ÇÉ': 'pya', '„Å¥„ÇÖ': 'pyu', '„Å¥„Çá': 'pyo',
            // „Ç´„Çø„Ç´„Éä
            '„Ç¢': 'a', '„Ç§': 'i', '„Ç¶': 'u', '„Ç®': 'e', '„Ç™': 'o',
            '„Ç´': 'ka', '„Ç≠': 'ki', '„ÇØ': 'ku', '„Ç±': 'ke', '„Ç≥': 'ko',
            '„Çµ': 'sa', '„Ç∑': 'shi', '„Çπ': 'su', '„Çª': 'se', '„ÇΩ': 'so',
            '„Çø': 'ta', '„ÉÅ': 'chi', '„ÉÑ': 'tsu', '„ÉÜ': 'te', '„Éà': 'to',
            '„Éä': 'na', '„Éã': 'ni', '„Éå': 'nu', '„Éç': 'ne', '„Éé': 'no',
            '„Éè': 'ha', '„Éí': 'hi', '„Éï': 'fu', '„Éò': 'he', '„Éõ': 'ho',
            '„Éû': 'ma', '„Éü': 'mi', '„É†': 'mu', '„É°': 'me', '„É¢': 'mo',
            '„É§': 'ya', '„É¶': 'yu', '„É®': 'yo',
            '„É©': 'ra', '„É™': 'ri', '„É´': 'ru', '„É¨': 're', '„É≠': 'ro',
            '„ÉØ': 'wa', '„É≤': 'wo', '„É≥': 'n',
            '„Ç¨': 'ga', '„ÇÆ': 'gi', '„Ç∞': 'gu', '„Ç≤': 'ge', '„Ç¥': 'go',
            '„Ç∂': 'za', '„Ç∏': 'ji', '„Ç∫': 'zu', '„Çº': 'ze', '„Çæ': 'zo',
            '„ÉÄ': 'da', '„ÉÇ': 'ji', '„ÉÖ': 'zu', '„Éá': 'de', '„Éâ': 'do',
            '„Éê': 'ba', '„Éì': 'bi', '„Éñ': 'bu', '„Éô': 'be', '„Éú': 'bo',
            '„Éë': 'pa', '„Éî': 'pi', '„Éó': 'pu', '„Éö': 'pe', '„Éù': 'po',
            '„Ç≠„É£': 'kya', '„Ç≠„É•': 'kyu', '„Ç≠„Éß': 'kyo',
            '„Ç∑„É£': 'sha', '„Ç∑„É•': 'shu', '„Ç∑„Éß': 'sho',
            '„ÉÅ„É£': 'cha', '„ÉÅ„É•': 'chu', '„ÉÅ„Éß': 'cho',
            '„Éã„É£': 'nya', '„Éã„É•': 'nyu', '„Éã„Éß': 'nyo',
            '„Éí„É£': 'hya', '„Éí„É•': 'hyu', '„Éí„Éß': 'hyo',
            '„Éü„É£': 'mya', '„Éü„É•': 'myu', '„Éü„Éß': 'myo',
            '„É™„É£': 'rya', '„É™„É•': 'ryu', '„É™„Éß': 'ryo',
            '„ÇÆ„É£': 'gya', '„ÇÆ„É•': 'gyu', '„ÇÆ„Éß': 'gyo',
            '„Ç∏„É£': 'ja', '„Ç∏„É•': 'ju', '„Ç∏„Éß': 'jo',
            '„Éì„É£': 'bya', '„Éì„É•': 'byu', '„Éì„Éß': 'byo',
            '„Éî„É£': 'pya', '„Éî„É•': 'pyu', '„Éî„Éß': 'pyo',
            '„Éº': '-'
        };

        // VRoid„Å®CG„É¢„Éá„É™„É≥„Ç∞Áî®Ë™û„Éá„Éº„Çø
        const vroidWords = [
            { japanese: '„Éñ„Ç§„É≠„Ç§„Éâ', romaji: 'buiroido' },
            { japanese: '„Çπ„Çø„Ç∏„Ç™', romaji: 'sutajio' },
            { japanese: '„Ç¢„Éê„Çø„Éº', romaji: 'abataa' },
            { japanese: '„É¢„Éá„É™„É≥„Ç∞', romaji: 'moderingu' },
            { japanese: '„ÉÜ„ÇØ„Çπ„ÉÅ„É£', romaji: 'tekusuchaa' },
            { japanese: '„Éú„Éº„É≥', romaji: 'boon' },
            { japanese: '„É™„ÇÆ„É≥„Ç∞', romaji: 'rigingu' },
            { japanese: '„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥', romaji: 'animeeshon' },
            { japanese: '„Ç®„ÇØ„Çπ„Éù„Éº„Éà', romaji: 'ekusupooto' },
            { japanese: '„Ç§„É≥„Éù„Éº„Éà', romaji: 'inpooto' },
            { japanese: '„Éû„ÉÜ„É™„Ç¢„É´', romaji: 'materiaru' },
            { japanese: '„É°„ÉÉ„Ç∑„É•', romaji: 'messhu' },
            { japanese: '„Çπ„Ç≠„Éã„É≥„Ç∞', romaji: 'sukiningu' },
            { japanese: '„Ç¶„Çß„Ç§„Éà', romaji: 'weito' },
            { japanese: '„Éê„Éº„ÉÜ„ÉÉ„ÇØ„Çπ', romaji: 'baatekkusu' },
            { japanese: '„Éù„É™„Ç¥„É≥', romaji: 'porigon' },
            { japanese: '„Ç∑„Çß„Éº„ÉÄ„Éº', romaji: 'sheedaa' },
            { japanese: '„É©„Ç§„ÉÜ„Ç£„É≥„Ç∞', romaji: 'raitingu' },
            { japanese: '„É¨„É≥„ÉÄ„É™„É≥„Ç∞', romaji: 'rendaringu' },
            { japanese: '„Åã„Åø„ÅÆ„Åë', romaji: 'kaminoke' },
            { japanese: '„Å≤„Åµ', romaji: 'hifu' },
            { japanese: '„Åµ„Åè', romaji: 'fuku' },
            { japanese: '„ÇÅ„Å†„Åæ', romaji: 'medama' },
            { japanese: '„Åã„Åä', romaji: 'kao' },
            { japanese: '„Åã„Çâ„Å†', romaji: 'karada' },
            { japanese: '„ÅÜ„Åß', romaji: 'ude' },
            { japanese: '„ÅÇ„Åó', romaji: 'ashi' },
            { japanese: '„Å¶„ÅÆ„Å≤„Çâ', romaji: 'tenohira' },
            { japanese: '„ÇÜ„Å≥', romaji: 'yubi' },
            { japanese: '„Å§„ÇÅ', romaji: 'tsume' },
            { japanese: '„Éù„Éº„Ç∫', romaji: 'poozu' },
            { japanese: '„Åæ„ÇÜ„Åí', romaji: 'mayuge' }
        ];

        const cgModelingWords = [
            { japanese: '„É¶„Éº„Éñ„Ç§', romaji: 'yuubui' },
            { japanese: '„Éé„Éº„Éû„É´„Éû„ÉÉ„Éó', romaji: 'noomarumappu' },
            { japanese: '„Ç¢„É≥„Éì„Ç®„É≥„Éà„Ç™„ÇØ„É´„Éº„Ç∏„Éß„É≥', romaji: 'anbientookuruujon' },
            { japanese: '„Çµ„Éñ„Éá„Ç£„Éì„Ç∏„Éß„É≥', romaji: 'sabudibijon' },
            { japanese: '„Éà„É©„É≥„Çπ„Éï„Ç©„Éº„É†', romaji: 'toransufoomu' },
            { japanese: '„Ç¢„Éº„Éû„ÉÅ„É•„Ç¢', romaji: 'aamachua' },
            { japanese: '„Ç≠„Éº„Éï„É¨„Éº„É†', romaji: 'kiifureemu' },
            { japanese: '„Çπ„Ç´„É´„Éó„Éà', romaji: 'sukarupito' },
            { japanese: '„ÉÄ„Ç§„Éä„Éü„ÉÉ„ÇØ„Éà„Éù„É≠„Ç∏„Éº', romaji: 'dainamikkutoporojii' },
            { japanese: '„É≠„Éº„Éù„É™', romaji: 'roopori' },
            { japanese: '„Éè„Ç§„Éù„É™', romaji: 'haipori' },
            { japanese: '„Éî„Éº„Éì„Éº„Ç¢„Éº„É´', romaji: 'piibiiaaru' },
            { japanese: '„Éñ„É´„Éº„Éó„É™„É≥„Éà', romaji: 'buruupurinto' },
            { japanese: '„Éé„Éº„Éâ', romaji: 'noodo' },
            { japanese: '„Ç®„Éü„ÉÉ„Ç∑„Éñ', romaji: 'emisshibu' },
            { japanese: '„É©„Éï„Éç„Çπ', romaji: 'rafunesu' },
            { japanese: '„É°„Çø„É™„ÉÉ„ÇØ', romaji: 'metarikku' },
            { japanese: '„Ç≥„É™„Ç∏„Éß„É≥', romaji: 'korijon' },
            { japanese: '„Éë„Éº„ÉÜ„Ç£„ÇØ„É´', romaji: 'paatikuru' },
            { japanese: '„Éó„É≠„Ç∑„Éº„Ç∏„É£„É´', romaji: 'puroshijaru' },
            { japanese: '„Éô„ÇØ„Çø„Éº', romaji: 'bekutaa' },
            { japanese: '„ÇØ„Ç©„Éº„Çø„Éã„Ç™„É≥', romaji: 'kuootanion' },
            { japanese: '„Ç∑„Çß„Ç§„Éó„Ç≠„Éº', romaji: 'sheipukii' },
            { japanese: '„Ç≥„É≥„Éù„Ç∏„ÉÉ„Éà', romaji: 'konpojitto' },
            { japanese: '„Éá„Éê„ÉÉ„Ç∞', romaji: 'debaggu' },
            { japanese: '„Éì„É´„Éâ', romaji: 'birudo' },
            { japanese: '„Ç¢„Çª„ÉÉ„Éà', romaji: 'asetto' },
            { japanese: '„ÉØ„Ç§„É§„Éº„Éï„É¨„Éº„É†', romaji: 'waiaafureemu' },
            { japanese: '„Ç∑„Éº„É≥', romaji: 'shiin' },
            { japanese: '„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà', romaji: 'obujekuto' },
            { japanese: '„É¢„Éá„Ç£„Éï„Ç°„Ç§„Ç¢', romaji: 'modifuaia' },
            { japanese: '„Éî„ÇØ„Çª„É´', romaji: 'pikuseru' },
            { japanese: '„Éñ„Éº„É™„Ç¢„É≥', romaji: 'buurian' },
            { japanese: '„Ç´„Éº„ÇΩ„É´', romaji: 'kaasoru' },
            { japanese: '„Ç∞„É™„ÉÉ„Éâ', romaji: 'guriddo' },
            { japanese: '„Ç§„Éº„Ç∏„É≥„Ç∞', romaji: 'iijingu' },
            { japanese: '„Ç´„Éº„Éñ', romaji: 'kaabu' },
            { japanese: '„Éá„Éó„Çπ', romaji: 'depusu' },
            { japanese: '„Ç¢„É´„Éï„Ç°', romaji: 'arufa' },
            { japanese: '„Éñ„É©„Éº', romaji: 'buraa' },
            { japanese: '„Ç´„É™„É≥„Ç∞', romaji: 'karingu' },
            { japanese: '„Éá„Ç´„Éº„É´', romaji: 'dekaaru' },
            { japanese: '„Ç®„Éï„Çß„ÇØ„Éà', romaji: 'efekuto' },
            { japanese: '„Éï„Ç£„É´„Çø', romaji: 'firuta' },
            { japanese: '„ÇÆ„Ç∫„É¢', romaji: 'gizumo' },
            { japanese: '„Éè„Ç§„Éà„Éû„ÉÉ„Éó', romaji: 'haitomappu' },
            { japanese: '„Ç§„É©„Éá„Ç£„Ç¢„É≥„Çπ', romaji: 'iradeiansu' },
            { japanese: '„É¨„Ç§„É§„Éº', romaji: 'reiyaa' },
            { japanese: '„Éû„ÉÉ„Éî„É≥„Ç∞', romaji: 'mappingu' },
            { japanese: '„Éü„ÉÉ„Éó„Éû„ÉÉ„Éó', romaji: 'mippumappu' },
            { japanese: '„Ç™„ÇØ„É´„Éº„Ç∏„Éß„É≥', romaji: 'okuruujon' },
            { japanese: '„Éë„Éº„Çπ„Éö„ÇØ„ÉÜ„Ç£„Éñ', romaji: 'paasupekutibu' },
            { japanese: '„Éó„É™„Éü„ÉÜ„Ç£„Éñ', romaji: 'purimitibu' },
            { japanese: '„É™„Éï„É¨„ÇØ„Ç∑„Éß„É≥', romaji: 'rifurekushon' },
            { japanese: '„Çπ„Ç±„Éº„É´', romaji: 'sukeeru' },
            { japanese: '„Çø„Ç§„É´', romaji: 'tairu' },
            { japanese: '„Éì„É•„Éº„Éù„Éº„Éà', romaji: 'byuupooto' }
        ];

        // „Ç´„Çø„Ç´„Éä„Çí„Å≤„Çâ„Åå„Å™„Å´Â§âÊèõ
        function katakanaToHiragana(str) {
            return str.replace(/[\u30a1-\u30f6]/g, function(match) {
                return String.fromCharCode(match.charCodeAt(0) - 0x60);
            });
        }

        // ÂçòË™û„É™„Çπ„Éà„ÅÆÂàùÊúüÂåñ
        const allWords = {
            katakana: [...vroidWords, ...cgModelingWords],
            hiragana: [...vroidWords, ...cgModelingWords].map(word => ({
                japanese: katakanaToHiragana(word.japanese),
                romaji: word.romaji
            }))
        };

        // ===== „Ç≤„Éº„É†Áä∂ÊÖãÁÆ°ÁêÜ =====
        class GameState {
            constructor() {
                this.currentScreen = 'menu';
                this.gameSettings = {
                    mode: 'katakana',
                    difficulty: 'normal',
                    soundEnabled: true,
                    inputMode: 'qwerty'
                };
                this.gameData = {
                    score: 0,
                    timeLeft: 60,
                    combo: 0,
                    maxCombo: 0,
                    wordsTyped: 0,
                    totalKeystrokes: 0,
                    correctKeystrokes: 0,
                    currentInput: '',
                    words: [],
                    gameStartTime: null,
                    isGameActive: false,
                    isPaused: false
                };
                this.tutorialStep = 0;
                
                this.loadSettings();
                this.loadPlayerData();
            }

            loadSettings() {
                try {
                    const saved = localStorage.getItem('cgTypingSettings');
                    if (saved) {
                        this.gameSettings = { ...this.gameSettings, ...JSON.parse(saved) };
                    }
                } catch (e) {
                    console.warn('Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', e);
                }
            }

            saveSettings() {
                try {
                    localStorage.setItem('cgTypingSettings', JSON.stringify(this.gameSettings));
                } catch (e) {
                    console.warn('Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', e);
                }
            }

            loadPlayerData() {
                try {
                    const saved = localStorage.getItem('cgTypingPlayerData');
                    if (saved) {
                        this.playerData = JSON.parse(saved);
                    } else {
                        this.playerData = {
                            level: 1,
                            xp: 0,
                            totalGames: 0,
                            bestScore: 0,
                            totalWordsTyped: 0,
                            totalPlayTime: 0,
                            recentGames: [],
                            achievements: []
                        };
                    }
                } catch (e) {
                    console.warn('„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', e);
                    this.playerData = {
                        level: 1,
                        xp: 0,
                        totalGames: 0,
                        bestScore: 0,
                        totalWordsTyped: 0,
                        totalPlayTime: 0,
                        recentGames: [],
                        achievements: []
                    };
                }
            }

            savePlayerData() {
                try {
                    localStorage.setItem('cgTypingPlayerData', JSON.stringify(this.playerData));
                } catch (e) {
                    console.warn('„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', e);
                }
            }

            getXPForLevel(level) {
                return level * 100;
            }

            addXP(amount) {
                const oldLevel = this.playerData.level;
                this.playerData.xp += amount;
                
                let currentLevelXP = this.getXPForLevel(this.playerData.level);
                while (this.playerData.xp >= currentLevelXP) {
                    this.playerData.xp -= currentLevelXP;
                    this.playerData.level++;
                    currentLevelXP = this.getXPForLevel(this.playerData.level);
                }
                
                return this.playerData.level > oldLevel;
            }

            getCurrentLevelProgress() {
                const currentLevelXP = this.getXPForLevel(this.playerData.level);
                return (this.playerData.xp / currentLevelXP) * 100;
            }

            resetGame() {
                this.gameData = {
                    score: 0,
                    timeLeft: GAME_CONFIG.durations[this.gameSettings.difficulty],
                    combo: 0,
                    maxCombo: 0,
                    wordsTyped: 0,
                    totalKeystrokes: 0,
                    correctKeystrokes: 0,
                    currentInput: '',
                    words: [],
                    gameStartTime: null,
                    isGameActive: false,
                    isPaused: false
                };
            }
        }

        // ===== „Çµ„Ç¶„É≥„Éâ„Ç∑„Çπ„ÉÜ„É† =====
        class SoundSystem {
            constructor() {
                this.sounds = {};
                this.enabled = true;
                this.loadSounds();
            }

            loadSounds() {
                const soundFiles = {
                    type: 'sounds/type.mp3',
                    correct: 'sounds/correct.mp3',
                    word_complete: 'sounds/word_complete.mp3',
                    wrong: 'sounds/wrong.mp3',
                    combo: 'sounds/combo_increase.mp3',
                    combo_break: 'sounds/combo_break.mp3',
                    click: 'sounds/click.mp3',
                    bgm: 'sounds/bgm.mp3'
                };

                for (const [name, path] of Object.entries(soundFiles)) {
                    try {
                        const audio = new Audio(path);
                        audio.volume = name === 'bgm' ? 0.3 : 0.7;
                        audio.preload = 'auto';
                        audio.onerror = () => {
                            console.warn(`„Çµ„Ç¶„É≥„Éâ„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${path}`);
                            this.sounds[name] = null;
                        };
                        this.sounds[name] = audio;
                    } catch (e) {
                        console.warn(`„Çµ„Ç¶„É≥„Éâ„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó: ${name}`, e);
                        this.sounds[name] = null;
                    }
                }

                if (this.sounds.bgm) {
                    this.sounds.bgm.loop = true;
                }
            }

            play(soundName, volume = null) {
                if (!this.enabled || !this.sounds[soundName]) return;
                
                try {
                    const sound = this.sounds[soundName];
                    if (volume !== null) sound.volume = volume;
                    sound.currentTime = 0;
                    sound.play().catch(e => {
                        console.warn(`„Çµ„Ç¶„É≥„ÉâÂÜçÁîü„Ç®„É©„Éº (${soundName}):`, e);
                    });
                } catch (e) {
                    console.warn(`„Çµ„Ç¶„É≥„ÉâÂÜçÁîü„Ç®„É©„Éº (${soundName}):`, e);
                }
            }

            playBGM() {
                if (this.enabled && this.sounds.bgm) {
                    this.sounds.bgm.play().catch(e => {
                        console.warn('BGMÂÜçÁîü„Ç®„É©„Éº:', e);
                    });
                }
            }

            stopBGM() {
                if (this.sounds.bgm) {
                    this.sounds.bgm.pause();
                    this.sounds.bgm.currentTime = 0;
                }
            }

            setEnabled(enabled) {
                this.enabled = enabled;
                if (!enabled) {
                    this.stopBGM();
                }
            }
        }

        // ===== ÂçòË™ûÁÆ°ÁêÜ„ÇØ„É©„Çπ =====
        class Word {
            constructor(wordData, x, speed) {
                this.japanese = wordData.japanese;
                this.romaji = wordData.romaji;
                this.x = x;
                this.y = -60;
                this.speed = speed;
                this.typedLength = 0;
                this.isCompleted = false;
                this.element = this.createElement();
                this.addToDOM();
            }

            createElement() {
                const element = document.createElement('div');
                element.className = 'absolute bg-white/90 rounded-lg p-3 shadow-lg transform transition-all duration-200';
                element.style.left = this.x + 'px';
                element.style.top = this.y + 'px';
                element.style.minWidth = '120px';
                element.innerHTML = `
                    <div class="text-lg font-bold text-gray-800 mb-1">${this.japanese}</div>
                    <div class="text-sm font-mono">
                        <span class="typed text-green-600"></span><span class="remaining text-gray-600">${this.romaji}</span>
                    </div>
                `;
                return element;
            }

            addToDOM() {
                document.getElementById('wordsContainer').appendChild(this.element);
            }

            update() {
                if (this.isCompleted) return false;
                
                this.y += this.speed;
                this.element.style.top = this.y + 'px';
                
                // ÁîªÈù¢‰∏ã„Å´Âà∞ÈÅî„Åó„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (this.y > window.innerHeight + 100) {
                    this.remove();
                    return false;
                }
                
                return true;
            }

            updateDisplay() {
                const typedSpan = this.element.querySelector('.typed');
                const remainingSpan = this.element.querySelector('.remaining');
                
                typedSpan.textContent = this.romaji.substring(0, this.typedLength);
                remainingSpan.textContent = this.romaji.substring(this.typedLength);
                
                // ÂÖ•Âäõ„Éü„Çπ„ÅÆÂ†¥Âêà„ÅØËÉåÊôØ„ÇíËµ§„Åè„Åô„Çã
                if (this.typedLength > 0 && !this.romaji.startsWith(gameState.gameData.currentInput)) {
                    this.element.classList.add('bg-red-200');
                } else {
                    this.element.classList.remove('bg-red-200');
                }
            }

            checkInput(input) {
                if (this.romaji.startsWith(input)) {
                    this.typedLength = input.length;
                    this.updateDisplay();
                    
                    if (input === this.romaji) {
                        this.complete();
                        return true;
                    }
                }
                return false;
            }

            complete() {
                this.isCompleted = true;
                this.element.classList.add('animate-pulse', 'bg-green-200');
                
                // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Ç®„Éï„Çß„ÇØ„Éà
                this.createParticles();
                
                // Â∞ë„ÅóÈÅÖ„Çå„Å¶ÂâäÈô§
                setTimeout(() => this.remove(), 300);
            }

            createParticles() {
                const rect = this.element.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                for (let i = 0; i < 10; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle w-2 h-2 bg-yellow-400 rounded-full';
                    particle.style.left = centerX + 'px';
                    particle.style.top = centerY + 'px';
                    particle.style.setProperty('--dx', (Math.random() - 0.5) * 200 + 'px');
                    particle.style.setProperty('--dy', (Math.random() - 0.5) * 200 + 'px');
                    
                    document.getElementById('particlesContainer').appendChild(particle);
                    
                    setTimeout(() => particle.remove(), 1000);
                }
            }

            remove() {
                if (this.element && this.element.parentNode) {
                    this.element.parentNode.removeChild(this.element);
                }
            }
        }

        // ===== „É°„Ç§„É≥„Ç≤„Éº„É†„ÇØ„É©„Çπ =====
        class TypingGame {
            constructor() {
                this.gameState = new GameState();
                this.soundSystem = new SoundSystem();
                this.wordSpawnTimer = null;
                this.gameTimer = null;
                this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.createKeyboards();
                this.updateUI();
                this.showScreen('menu');
                
                // Ë®≠ÂÆö„ÇíÈü≥Èüø„Ç∑„Çπ„ÉÜ„É†„Å´ÈÅ©Áî®
                this.soundSystem.setEnabled(this.gameState.gameSettings.soundEnabled);
            }

            setupEventListeners() {
                // „É°„Éã„É•„Éº„Éú„Çø„É≥
                document.getElementById('startGame').addEventListener('click', () => this.startGame());
                document.getElementById('tutorialBtn').addEventListener('click', () => this.showTutorial());
                document.getElementById('settingsBtn').addEventListener('click', () => this.showSettings());
                document.getElementById('statisticsBtn').addEventListener('click', () => this.showStatistics());
                
                // Ë®≠ÂÆöÁîªÈù¢
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.changeMode(btn.dataset.mode));
                });
                document.querySelectorAll('.difficulty-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.changeDifficulty(btn.dataset.difficulty));
                });
                document.getElementById('soundToggle').addEventListener('change', (e) => {
                    this.gameState.gameSettings.soundEnabled = e.target.checked;
                    this.soundSystem.setEnabled(e.target.checked);
                    this.gameState.saveSettings();
                });
                document.getElementById('backToMenu').addEventListener('click', () => this.showScreen('menu'));
                
                // „Ç≤„Éº„É†ÁîªÈù¢
                document.getElementById('pauseBtn').addEventListener('click', () => this.pauseGame());
                document.getElementById('toggleInput').addEventListener('click', () => this.toggleInputMode());
                
                // „Éù„Éº„Ç∫ÁîªÈù¢
                document.getElementById('resumeGame').addEventListener('click', () => this.resumeGame());
                document.getElementById('restartGame').addEventListener('click', () => this.restartGame());
                document.getElementById('quitGame').addEventListener('click', () => this.quitGame());
                
                // ÁµêÊûúÁîªÈù¢
                document.getElementById('playAgain').addEventListener('click', () => this.startGame());
                document.getElementById('backToMenuFromResults').addEventListener('click', () => this.showScreen('menu'));
                
                // Áµ±Ë®àÁîªÈù¢
                document.getElementById('backToMenuFromStats').addEventListener('click', () => this.showScreen('menu'));
                
                // „ÉÅ„É•„Éº„Éà„É™„Ç¢„É´
                document.getElementById('tutorialPrev').addEventListener('click', () => this.prevTutorialStep());
                document.getElementById('tutorialNext').addEventListener('click', () => this.nextTutorialStep());
                
                // „Ç≠„Éº„Éú„Éº„ÉâÂÖ•Âäõ
                document.addEventListener('keydown', (e) => this.handleKeyInput(e));
                
                // „É™„Çµ„Ç§„Ç∫ÂØæÂøú
                window.addEventListener('resize', () => this.handleResize());
            }

            createKeyboards() {
                this.createQWERTYKeyboard();
                this.createFlickKeyboard();
            }

            createQWERTYKeyboard() {
                const container = document.getElementById('qwertyKeyboard');
                const keys = [
                    ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'],
                    ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l', '‚Üê'],
                    ['z', 'x', 'c', 'v', 'b', 'n', 'm', 'Ê∂àÂéª']
                ];
                
                container.innerHTML = '';
                
                keys.forEach((row, rowIndex) => {
                    row.forEach(key => {
                        const button = document.createElement('button');
                        button.textContent = key.toUpperCase();
                        button.className = 'bg-white/80 hover:bg-white text-gray-800 font-semibold py-2 px-1 rounded transition-all transform active:scale-95';
                        
                        if (key === '‚Üê') {
                            button.className += ' col-span-1';
                            button.addEventListener('click', () => this.handleBackspace());
                        } else if (key === 'Ê∂àÂéª') {
                            button.className += ' col-span-2';
                            button.addEventListener('click', () => this.handleClear());
                        } else {
                            button.addEventListener('click', () => this.handleCharInput(key));
                        }
                        
                        container.appendChild(button);
                    });
                });
            }

            createFlickKeyboard() {
                const container = document.getElementById('flickKeyboard');
                const flickKeys = [
                    { main: '„ÅÇ', flicks: ['„ÅÑ', '„ÅÜ', '„Åà', '„Åä'] },
                    { main: '„Åã', flicks: ['„Åç', '„Åè', '„Åë', '„Åì'] },
                    { main: '„Åï', flicks: ['„Åó', '„Åô', '„Åõ', '„Åù'] },
                    { main: '„Åü', flicks: ['„Å°', '„Å§', '„Å¶', '„Å®'] },
                    { main: '„Å™', flicks: ['„Å´', '„Å¨', '„Å≠', '„ÅÆ'] },
                    { main: '„ÅØ', flicks: ['„Å≤', '„Åµ', '„Å∏', '„Åª'] },
                    { main: '„Åæ', flicks: ['„Åø', '„ÇÄ', '„ÇÅ', '„ÇÇ'] },
                    { main: '„ÇÑ', flicks: ['„ÇÜ', '„Çà'] },
                    { main: '„Çâ', flicks: ['„Çä', '„Çã', '„Çå', '„Çç'] },
                    { main: '„Çè', flicks: ['„Çí', '„Çì'] },
                    { main: '‚Üê', type: 'backspace' },
                    { main: 'Ê∂àÂéª', type: 'clear' },
                    { main: '„Çõ„Çú', flicks: ['„Åå', '„Å±'] },
                    { main: '„Éº', type: 'dash' },
                    { main: 'ABC', type: 'toggle' }
                ];
                
                container.innerHTML = '';
                
                flickKeys.forEach(keyData => {
                    const button = document.createElement('button');
                    button.className = 'flick-key bg-white/80 hover:bg-white text-gray-800 font-semibold py-3 px-2 rounded-lg transition-all relative';
                    button.innerHTML = `
                        <div class="text-lg">${keyData.main}</div>
                        ${keyData.flicks ? `
                            <div class="flick-hints">
                                <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-xs bg-blue-500 text-white px-1 rounded">${keyData.flicks[1] || ''}</div>
                                <div class="absolute top-1/2 -left-6 transform -translate-y-1/2 text-xs bg-blue-500 text-white px-1 rounded">${keyData.flicks[0] || ''}</div>
                                <div class="absolute top-1/2 -right-6 transform -translate-y-1/2 text-xs bg-blue-500 text-white px-1 rounded">${keyData.flicks[2] || ''}</div>
                                <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-xs bg-blue-500 text-white px-1 rounded">${keyData.flicks[3] || ''}</div>
                            </div>
                        ` : ''}
                    `;
                    
                    // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà„ÅÆÂá¶ÁêÜ
                    if (keyData.type === 'backspace') {
                        button.addEventListener('click', () => this.handleBackspace());
                    } else if (keyData.type === 'clear') {
                        button.addEventListener('click', () => this.handleClear());
                    } else if (keyData.type === 'toggle') {
                        button.addEventListener('click', () => this.toggleInputMode());
                    } else if (keyData.type === 'dash') {
                        button.addEventListener('click', () => this.handleKanaInput('„Éº'));
                    } else {
                        button.addEventListener('click', () => this.handleKanaInput(keyData.main));
                        
                        // „Éï„É™„ÉÉ„ÇØÂØæÂøúÔºàÁ∞°ÊòìÁâàÔºâ
                        if (keyData.flicks) {
                            let startY = 0;
                            button.addEventListener('touchstart', (e) => {
                                startY = e.touches[0].clientY;
                            });
                            button.addEventListener('touchend', (e) => {
                                const endY = e.changedTouches[0].clientY;
                                const deltaY = startY - endY;
                                if (Math.abs(deltaY) > 20) {
                                    if (deltaY > 0 && keyData.flicks[1]) {
                                        this.handleKanaInput(keyData.flicks[1]);
                                    } else if (deltaY < 0 && keyData.flicks[3]) {
                                        this.handleKanaInput(keyData.flicks[3]);
                                    }
                                }
                            });
                        }
                    }
                    
                    container.appendChild(button);
                });
            }

            handleKeyInput(e) {
                if (this.gameState.currentScreen !== 'game' || !this.gameState.gameData.isGameActive) return;
                
                e.preventDefault();
                
                if (e.key === 'Escape') {
                    this.pauseGame();
                } else if (e.key === 'Backspace') {
                    this.handleBackspace();
                } else if (e.key.length === 1 && e.key.match(/[a-z]/i)) {
                    this.handleCharInput(e.key.toLowerCase());
                }
            }

            handleCharInput(char) {
                if (!this.gameState.gameData.isGameActive) return;
                
                this.gameState.gameData.currentInput += char;
                this.gameState.gameData.totalKeystrokes++;
                
                this.soundSystem.play('type');
                this.updateInput();
                this.checkWordMatches();
            }

            handleKanaInput(kana) {
                if (!this.gameState.gameData.isGameActive) return;
                
                const romaji = kanaToRomaji[kana];
                if (romaji) {
                    this.gameState.gameData.currentInput += romaji;
                    this.gameState.gameData.totalKeystrokes++;
                    
                    this.soundSystem.play('type');
                    this.updateInput();
                    this.checkWordMatches();
                }
            }

            handleBackspace() {
                if (!this.gameState.gameData.isGameActive) return;
                
                if (this.gameState.gameData.currentInput.length > 0) {
                    this.gameState.gameData.currentInput = this.gameState.gameData.currentInput.slice(0, -1);
                    this.updateInput();
                    this.updateWordDisplays();
                }
            }

            handleClear() {
                if (!this.gameState.gameData.isGameActive) return;
                
                this.gameState.gameData.currentInput = '';
                this.gameState.gameData.combo = 0;
                this.updateInput();
                this.updateWordDisplays();
                this.soundSystem.play('combo_break');
            }

            checkWordMatches() {
                const input = this.gameState.gameData.currentInput;
                let wordCompleted = false;
                
                for (let i = this.gameState.gameData.words.length - 1; i >= 0; i--) {
                    const word = this.gameState.gameData.words[i];
                    if (word.checkInput(input)) {
                        // ÂçòË™ûÂÆåÊàê
                        this.completeWord(word, i);
                        wordCompleted = true;
                        break;
                    }
                }
                
                if (!wordCompleted) {
                    // ÂÖ•Âäõ„ÅåÊ≠£„Åó„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    let isValidInput = false;
                    for (const word of this.gameState.gameData.words) {
                        if (word.romaji.startsWith(input)) {
                            isValidInput = true;
                            break;
                        }
                    }
                    
                    if (!isValidInput && input.length > 0) {
                        // ÈñìÈÅï„Å£„ÅüÂÖ•Âäõ
                        this.gameState.gameData.combo = 0;
                        this.soundSystem.play('wrong');
                        this.triggerScreenShake();
                    } else if (isValidInput) {
                        this.gameState.gameData.correctKeystrokes++;
                    }
                }
                
                this.updateWordDisplays();
                this.updateUI();
            }

            completeWord(word, index) {
                const wordLength = word.romaji.length;
                const points = wordLength * 10 * Math.max(1, this.gameState.gameData.combo);
                
                this.gameState.gameData.score += points;
                this.gameState.gameData.combo++;
                this.gameState.gameData.wordsTyped++;
                this.gameState.gameData.correctKeystrokes += wordLength;
                this.gameState.gameData.currentInput = '';
                
                if (this.gameState.gameData.combo > this.gameState.gameData.maxCombo) {
                    this.gameState.gameData.maxCombo = this.gameState.gameData.combo;
                }
                
                // „Ç≥„É≥„Éú„Ç®„Éï„Çß„ÇØ„Éà
                if (this.gameState.gameData.combo % 5 === 0) {
                    this.soundSystem.play('combo');
                    this.triggerComboEffect();
                } else {
                    this.soundSystem.play('word_complete');
                }
                
                // ÂçòË™û„ÇíÈÖçÂàó„Åã„ÇâÂâäÈô§
                this.gameState.gameData.words.splice(index, 1);
                
                this.updateUI();
            }

            triggerComboEffect() {
                const comboElement = document.getElementById('combo');
                comboElement.classList.add('combo-pulse');
                setTimeout(() => comboElement.classList.remove('combo-pulse'), 300);
            }

            triggerScreenShake() {
                document.getElementById('gameContainer').classList.add('screen-shake');
                setTimeout(() => {
                    document.getElementById('gameContainer').classList.remove('screen-shake');
                }, 300);
            }

            updateWordDisplays() {
                this.gameState.gameData.words.forEach(word => {
                    word.updateDisplay();
                });
            }

            updateInput() {
                const inputElement = document.getElementById('currentInput');
                const input = this.gameState.gameData.currentInput;
                
                // ÂÖ•Âäõ„ÅÆËâ≤ÂàÜ„ÅëË°®Á§∫
                let displayHTML = '';
                let isValidPrefix = false;
                
                for (const word of this.gameState.gameData.words) {
                    if (word.romaji.startsWith(input)) {
                        isValidPrefix = true;
                        break;
                    }
                }
                
                if (input.length === 0) {
                    displayHTML = '<span class="text-gray-400">ÂÖ•ÂäõÂæÖ„Å°...</span>';
                } else if (isValidPrefix) {
                    displayHTML = `<span class="text-green-400">${input}</span>`;
                } else {
                    displayHTML = `<span class="text-red-400">${input}</span>`;
                }
                
                inputElement.innerHTML = displayHTML;
            }

            spawnWord() {
                if (!this.gameState.gameData.isGameActive) return;
                
                const words = this.getCurrentWordList();
                const randomWord = words[Math.floor(Math.random() * words.length)];
                const x = Math.random() * (window.innerWidth - 200) + 50;
                const speed = GAME_CONFIG.fallSpeeds[this.gameState.gameSettings.difficulty];
                
                const word = new Word(randomWord, x, speed);
                this.gameState.gameData.words.push(word);
            }

            getCurrentWordList() {
                const mode = this.gameState.gameSettings.mode;
                if (mode === 'mixed') {
                    return Math.random() < 0.5 ? allWords.katakana : allWords.hiragana;
                }
                return allWords[mode] || allWords.katakana;
            }

            updateWordsPosition() {
                for (let i = this.gameState.gameData.words.length - 1; i >= 0; i--) {
                    const word = this.gameState.gameData.words[i];
                    if (!word.update()) {
                        // ÁîªÈù¢Â§ñ„Å´Âá∫„ÅüÂçòË™û
                        this.gameState.gameData.words.splice(i, 1);
                        if (this.gameState.gameData.combo > 0) {
                            this.gameState.gameData.combo = 0;
                            this.soundSystem.play('combo_break');
                        }
                    }
                }
            }

            startGame() {
                this.soundSystem.play('click');
                this.gameState.resetGame();
                this.gameState.currentScreen = 'game';
                this.gameState.gameData.isGameActive = true;
                this.gameState.gameData.gameStartTime = Date.now();
                
                this.showScreen('game');
                this.updateUI();
                this.updateInput();
                
                // „Çø„Ç§„Éû„ÉºÈñãÂßã
                this.gameTimer = setInterval(() => {
                    if (!this.gameState.gameData.isPaused) {
                        this.gameState.gameData.timeLeft--;
                        this.updateUI();
                        
                        if (this.gameState.gameData.timeLeft <= 0) {
                            this.endGame();
                        }
                    }
                }, 1000);
                
                // ÂçòË™û„Çπ„Éù„Éº„É≥ÈñãÂßã
                this.wordSpawnTimer = setInterval(() => {
                    if (!this.gameState.gameData.isPaused) {
                        this.spawnWord();
                    }
                }, GAME_CONFIG.spawnIntervals[this.gameState.gameSettings.difficulty]);
                
                // „Ç≤„Éº„É†„É´„Éº„ÉóÈñãÂßã
                this.gameLoop();
                
                // BGMÈñãÂßã
                this.soundSystem.playBGM();
            }

            gameLoop() {
                if (!this.gameState.gameData.isGameActive) return;
                
                this.updateWordsPosition();
                
                if (this.gameState.gameData.isGameActive) {
                    requestAnimationFrame(() => this.gameLoop());
                }
            }

            pauseGame() {
                this.gameState.gameData.isPaused = true;
                this.showScreen('pause');
                this.soundSystem.stopBGM();
            }

            resumeGame() {
                this.gameState.gameData.isPaused = false;
                this.showScreen('game');
                this.soundSystem.playBGM();
            }

            restartGame() {
                this.endGame(false);
                this.startGame();
            }

            quitGame() {
                this.endGame(false);
                this.showScreen('menu');
            }

            endGame(saveData = true) {
                this.gameState.gameData.isGameActive = false;
                this.soundSystem.stopBGM();
                
                if (this.gameTimer) {
                    clearInterval(this.gameTimer);
                    this.gameTimer = null;
                }
                if (this.wordSpawnTimer) {
                    clearInterval(this.wordSpawnTimer);
                    this.wordSpawnTimer = null;
                }
                
                // ÊÆã„Å£„ÅüÂçòË™û„ÇíÂâäÈô§
                this.gameState.gameData.words.forEach(word => word.remove());
                this.gameState.gameData.words = [];
                
                // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Çí„ÇØ„É™„Ç¢
                document.getElementById('particlesContainer').innerHTML = '';
                
                if (saveData) {
                    this.saveGameResult();
                    this.showResults();
                }
            }

            saveGameResult() {
                const gameData = this.gameState.gameData;
                const playTime = (Date.now() - gameData.gameStartTime) / 1000;
                const wpm = Math.round((gameData.correctKeystrokes / 5) / (playTime / 60));
                const accuracy = gameData.totalKeystrokes > 0 ? 
                    Math.round((gameData.correctKeystrokes / gameData.totalKeystrokes) * 100) : 100;
                
                // XPË®àÁÆó
                const baseXP = Math.floor(gameData.score / 100);
                const comboBonus = Math.floor(gameData.maxCombo / 5) * 10;
                const accuracyBonus = accuracy >= 95 ? 50 : accuracy >= 90 ? 25 : 0;
                const totalXP = baseXP + comboBonus + accuracyBonus;
                
                // „Ç≤„Éº„É†Ë®òÈå≤„Çí‰øùÂ≠ò
                const gameRecord = {
                    date: new Date().toISOString(),
                    score: gameData.score,
                    wordsTyped: gameData.wordsTyped,
                    maxCombo: gameData.maxCombo,
                    wpm: wpm,
                    accuracy: accuracy,
                    difficulty: this.gameState.gameSettings.difficulty,
                    mode: this.gameState.gameSettings.mode,
                    playTime: playTime,
                    xpGained: totalXP
                };
                
                // „Éó„É¨„Ç§„É§„Éº„Éá„Éº„ÇøÊõ¥Êñ∞
                const playerData = this.gameState.playerData;
                playerData.totalGames++;
                playerData.totalWordsTyped += gameData.wordsTyped;
                playerData.totalPlayTime += playTime;
                
                if (gameData.score > playerData.bestScore) {
                    playerData.bestScore = gameData.score;
                    this.isNewRecord = true;
                }
                
                // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„ÉÅ„Çß„ÉÉ„ÇØ
                this.leveledUp = this.gameState.addXP(totalXP);
                this.xpGained = totalXP;
                
                // ÊúÄËøë„ÅÆ„Ç≤„Éº„É†Â±•Ê≠¥„Å´ËøΩÂä†
                playerData.recentGames.unshift(gameRecord);
                if (playerData.recentGames.length > 20) {
                    playerData.recentGames = playerData.recentGames.slice(0, 20);
                }
                
                // ÂÆüÁ∏æ„ÉÅ„Çß„ÉÉ„ÇØ
                this.checkAchievements(gameRecord);
                
                // „Éá„Éº„Çø‰øùÂ≠ò
                this.gameState.savePlayerData();
            }

            checkAchievements(gameRecord) {
                const achievements = [];
                
                if (gameRecord.score >= 1000 && !this.hasAchievement('score_1000')) {
                    achievements.push({ id: 'score_1000', name: '„Çπ„Ç≥„Ç¢1000ÈÅîÊàê', description: '1„Ç≤„Éº„É†„Åß1000ÁÇπ‰ª•‰∏ä„ÇíÁç≤Âæó' });
                }
                if (gameRecord.maxCombo >= 10 && !this.hasAchievement('combo_10')) {
                    achievements.push({ id: 'combo_10', name: '„Ç≥„É≥„Éú„Éû„Çπ„Çø„Éº', description: '10„Ç≥„É≥„Éú‰ª•‰∏ä„ÇíÈÅîÊàê' });
                }
                if (gameRecord.accuracy >= 95 && !this.hasAchievement('accuracy_95')) {
                    achievements.push({ id: 'accuracy_95', name: '„Éë„Éº„Éï„Çß„ÇØ„Éà', description: 'Ê≠£Á¢∫ÊÄß95%‰ª•‰∏ä„ÇíÈÅîÊàê' });
                }
                if (this.gameState.playerData.totalGames >= 10 && !this.hasAchievement('games_10')) {
                    achievements.push({ id: 'games_10', name: '„Éô„ÉÜ„É©„É≥', description: '10„Ç≤„Éº„É†‰ª•‰∏ä„Éó„É¨„Ç§' });
                }
                
                achievements.forEach(achievement => {
                    this.gameState.playerData.achievements.push({
                        ...achievement,
                        unlockedAt: new Date().toISOString()
                    });
                });
                
                this.newAchievements = achievements;
            }

            hasAchievement(id) {
                return this.gameState.playerData.achievements.some(a => a.id === id);
            }

            showResults() {
                this.gameState.currentScreen = 'results';
                this.showScreen('results');
                
                // ÁµêÊûúË°®Á§∫
                document.getElementById('finalScore').textContent = this.gameState.gameData.score;
                document.getElementById('finalWords').textContent = this.gameState.gameData.wordsTyped;
                document.getElementById('finalCombo').textContent = this.gameState.gameData.maxCombo;
                
                const playTime = (Date.now() - this.gameState.gameData.gameStartTime) / 1000;
                const wpm = Math.round((this.gameState.gameData.correctKeystrokes / 5) / (playTime / 60));
                const accuracy = this.gameState.gameData.totalKeystrokes > 0 ? 
                    Math.round((this.gameState.gameData.correctKeystrokes / this.gameState.gameData.totalKeystrokes) * 100) : 100;
                
                document.getElementById('finalWPM').textContent = wpm;
                document.getElementById('finalAccuracy').textContent = accuracy;
                
                // XPÁç≤ÂæóË°®Á§∫
                if (this.xpGained > 0) {
                    document.getElementById('xpAmount').textContent = this.xpGained;
                    document.getElementById('xpGained').classList.remove('hidden');
                }
                
                // Êñ∞Ë®òÈå≤Ë°®Á§∫
                if (this.isNewRecord) {
                    document.getElementById('newRecord').classList.remove('hidden');
                }
                
                // „É¨„Éô„É´„Ç¢„ÉÉ„ÉóË°®Á§∫
                if (this.leveledUp) {
                    document.getElementById('newLevel').textContent = this.gameState.playerData.level;
                    document.getElementById('levelUp').classList.remove('hidden');
                }
            }

            showTutorial() {
                this.tutorialStep = 0;
                this.showScreen('tutorial');
                this.updateTutorial();
            }

            updateTutorial() {
                const steps = [
                    {
                        title: '„Ç≤„Éº„É†„ÅÆÂü∫Êú¨',
                        content: `
                            <h3 class="font-bold mb-2">„Çø„Ç§„Éî„É≥„Ç∞„Ç≤„Éº„É†„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ</h3>
                            <p class="mb-2">ÁîªÈù¢‰∏ä„Åã„ÇâËêΩ„Å°„Å¶„Åè„ÇãÂçòË™û„ÅÆ„É≠„Éº„ÉûÂ≠ó„ÇíÊ≠£Á¢∫„Å´ÂÖ•Âäõ„Åó„Åæ„Åô„ÄÇ</p>
                            <p class="mb-2">‰æãÔºö„Äå„Éù„É™„Ç¥„É≥„Äç‚Üí„Äåporigon„Äç</p>
                            <p>Âà∂ÈôêÊôÇÈñìÂÜÖ„Å´„Åß„Åç„Çã„Å†„ÅëÂ§ö„Åè„ÅÆÂçòË™û„ÇíÂÖ•Âäõ„Åó„Å¶„Çπ„Ç≥„Ç¢„ÇíÁ®º„Åé„Åæ„Åó„Çá„ÅÜÔºÅ</p>
                        `
                    },
                    {
                        title: '„Ç≥„É≥„Éú„Ç∑„Çπ„ÉÜ„É†',
                        content: `
                            <h3 class="font-bold mb-2">„Ç≥„É≥„Éú„Åß„Çπ„Ç≥„Ç¢„Ç¢„ÉÉ„ÉóÔºÅ</h3>
                            <p class="mb-2">ÈÄ£Á∂ö„Åó„Å¶ÂçòË™û„ÇíÊ≠£Á¢∫„Å´ÂÖ•Âäõ„Åô„Çã„Å®„Ç≥„É≥„Éú„ÅåÂ¢óÂä†„Åó„Åæ„Åô„ÄÇ</p>
                            <p class="mb-2">„Ç≥„É≥„Éú„ÅåÈ´ò„ÅÑ„Åª„Å©Áç≤Âæó„Çπ„Ç≥„Ç¢„ÅåÂ¢óÂä†„Åó„Åæ„Åô„ÄÇ</p>
                            <p>„Éü„Çπ„Çí„Åó„Åü„ÇäÂçòË™û„ÇíË¶ãÈÄÉ„Åô„Å®„Ç≥„É≥„Éú„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Çã„ÅÆ„ÅßÊ≥®ÊÑèÔºÅ</p>
                        `
                    },
                    {
                        title: 'ÂÖ•Âäõ„É¢„Éº„Éâ',
                        content: `
                            <h3 class="font-bold mb-2">2„Å§„ÅÆÂÖ•Âäõ„É¢„Éº„Éâ</h3>
                            <p class="mb-2"><strong>QWERTY„É¢„Éº„ÉâÔºö</strong>PC„Ç≠„Éº„Éú„Éº„Éâ„Å®Âêå„ÅòÈÖçÂàó</p>
                            <p class="mb-2"><strong>„Éï„É™„ÉÉ„ÇØ„É¢„Éº„ÉâÔºö</strong>„Çπ„Éû„Éõ„ÅÆ„Éï„É™„ÉÉ„ÇØÂÖ•ÂäõÈ¢®</p>
                            <p>„Ç≤„Éº„É†‰∏≠„Åß„ÇÇ„ÄåÂàáÊõø„Äç„Éú„Çø„É≥„ÅßËá™Áî±„Å´Â§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ</p>
                        `
                    },
                    {
                        title: 'Ë®≠ÂÆö„Å®„Ç´„Çπ„Çø„Éû„Ç§„Ç∫',
                        content: `
                            <h3 class="font-bold mb-2">„Ç≤„Éº„É†„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫</h3>
                            <p class="mb-2"><strong>Ë°®Á§∫„É¢„Éº„ÉâÔºö</strong>„Ç´„Çø„Ç´„Éä„ÄÅ„Å≤„Çâ„Åå„Å™„ÄÅ„Éü„ÉÉ„ÇØ„Çπ</p>
                            <p class="mb-2"><strong>Èõ£ÊòìÂ∫¶Ôºö</strong>Âà∂ÈôêÊôÇÈñì„Å®ÂçòË™û„ÅÆËêΩ‰∏ãÈÄüÂ∫¶„ÅåÂ§âÂåñ</p>
                            <p class="mb-2"><strong>Áµ±Ë®àÊ©üËÉΩÔºö</strong>„Éó„É¨„Ç§Â±•Ê≠¥„ÇÑÊàêÈï∑„ÇíÁ¢∫Ë™ç</p>
                            <p>Ê∫ñÂÇô„Åå„Åß„Åç„Åü„Çâ„Ç≤„Éº„É†„ÇíÈñãÂßã„Åó„Åæ„Åó„Çá„ÅÜÔºÅ</p>
                        `
                    }
                ];
                
                const step = steps[this.tutorialStep];
                document.getElementById('tutorialContent').innerHTML = step.content;
                document.getElementById('tutorialStep').textContent = `${this.tutorialStep + 1} / ${steps.length}`;
                
                // „Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
                document.getElementById('tutorialPrev').disabled = this.tutorialStep === 0;
                document.getElementById('tutorialNext').textContent = 
                    this.tutorialStep === steps.length - 1 ? 'ÂÆå‰∫Ü' : 'Ê¨°„Å∏';
            }

            prevTutorialStep() {
                if (this.tutorialStep > 0) {
                    this.tutorialStep--;
                    this.updateTutorial();
                }
            }

            nextTutorialStep() {
                if (this.tutorialStep < 3) {
                    this.tutorialStep++;
                    this.updateTutorial();
                } else {
                    this.showScreen('menu');
                }
            }

            showSettings() {
                this.showScreen('settings');
                this.updateSettingsUI();
            }

            updateSettingsUI() {
                // „É¢„Éº„Éâ„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.toggle('bg-blue-500', btn.dataset.mode === this.gameState.gameSettings.mode);
                    btn.classList.toggle('text-white', btn.dataset.mode === this.gameState.gameSettings.mode);
                });
                
                // Èõ£ÊòìÂ∫¶„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
                document.querySelectorAll('.difficulty-btn').forEach(btn => {
                    btn.classList.toggle('bg-blue-500', btn.dataset.difficulty === this.gameState.gameSettings.difficulty);
                    btn.classList.toggle('text-white', btn.dataset.difficulty === this.gameState.gameSettings.difficulty);
                });
                
                // „Çµ„Ç¶„É≥„ÉâË®≠ÂÆö
                document.getElementById('soundToggle').checked = this.gameState.gameSettings.soundEnabled;
            }

            showStatistics() {
                this.showScreen('statistics');
                this.updateStatisticsUI();
            }

            updateStatisticsUI() {
                const playerData = this.gameState.playerData;
                
                // Âü∫Êú¨Áµ±Ë®à
                document.getElementById('totalGames').textContent = playerData.totalGames;
                document.getElementById('bestScore').textContent = playerData.bestScore;
                
                // Âπ≥ÂùáWPMË®àÁÆó
                const averageWPM = playerData.recentGames.length > 0 ? 
                    Math.round(playerData.recentGames.reduce((sum, game) => sum + game.wpm, 0) / playerData.recentGames.length) : 0;
                document.getElementById('averageWPM').textContent = averageWPM;
                
                // „É¨„Éô„É´ÈÄ≤Ë°åÁä∂Ê≥Å
                document.getElementById('currentLevel').textContent = playerData.level;
                document.getElementById('currentXP').textContent = playerData.xp;
                document.getElementById('nextLevelXP').textContent = this.gameState.getXPForLevel(playerData.level);
                document.getElementById('levelProgress').style.width = this.gameState.getCurrentLevelProgress() + '%';
                
                // ÂÆüÁ∏æË°®Á§∫
                const achievementsContainer = document.getElementById('achievements');
                achievementsContainer.innerHTML = '';
                
                playerData.achievements.forEach(achievement => {
                    const achievementElement = document.createElement('div');
                    achievementElement.className = 'achievement-badge text-white p-3 rounded-lg';
                    achievementElement.innerHTML = `
                        <div class="font-bold">${achievement.name}</div>
                        <div class="text-sm opacity-90">${achievement.description}</div>
                    `;
                    achievementsContainer.appendChild(achievementElement);
                });
                
                if (playerData.achievements.length === 0) {
                    achievementsContainer.innerHTML = '<p class="text-white/70">„Åæ„Å†ÂÆüÁ∏æ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                }
                
                // ÊúÄËøë„ÅÆ„Ç≤„Éº„É†Â±•Ê≠¥
                const recentGamesContainer = document.getElementById('recentGames');
                recentGamesContainer.innerHTML = '';
                
                playerData.recentGames.slice(0, 10).forEach(game => {
                    const gameElement = document.createElement('div');
                    gameElement.className = 'bg-white/10 rounded p-3 text-white';
                    const date = new Date(game.date).toLocaleDateString('ja-JP');
                    gameElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-bold">${game.score}pt</div>
                                <div class="text-sm opacity-75">${date}</div>
                            </div>
                            <div class="text-right text-sm">
                                <div>WPM: ${game.wpm}</div>
                                <div>Ê≠£Á¢∫ÊÄß: ${game.accuracy}%</div>
                            </div>
                        </div>
                    `;
                    recentGamesContainer.appendChild(gameElement);
                });
                
                if (playerData.recentGames.length === 0) {
                    recentGamesContainer.innerHTML = '<p class="text-white/70">„Åæ„Å†„Ç≤„Éº„É†Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                }
            }

            changeMode(mode) {
                this.gameState.gameSettings.mode = mode;
                this.gameState.saveSettings();
                this.updateUI();
                this.updateSettingsUI();
                this.soundSystem.play('click');
            }

            changeDifficulty(difficulty) {
                this.gameState.gameSettings.difficulty = difficulty;
                this.gameState.saveSettings();
                this.updateUI();
                this.updateSettingsUI();
                this.soundSystem.play('click');
            }

            toggleInputMode() {
                const currentMode = this.gameState.gameSettings.inputMode;
                this.gameState.gameSettings.inputMode = currentMode === 'qwerty' ? 'flick' : 'qwerty';
                this.gameState.saveSettings();
                this.updateInputModeUI();
                this.soundSystem.play('click');
            }

            updateInputModeUI() {
                const isQwerty = this.gameState.gameSettings.inputMode === 'qwerty';
                
                document.getElementById('qwertyKeyboard').classList.toggle('hidden', !isQwerty);
                document.getElementById('flickKeyboard').classList.toggle('hidden', isQwerty);
                document.getElementById('inputModeText').textContent = isQwerty ? '„Éï„É™„ÉÉ„ÇØÂÖ•Âäõ' : 'QWERTYÂÖ•Âäõ';
            }

            showScreen(screenName) {
                const screens = ['menu', 'game', 'settings', 'statistics', 'tutorial', 'pause', 'results'];
                screens.forEach(screen => {
                    const element = document.getElementById(screen + 'Screen');
                    if (element) {
                        element.classList.toggle('hidden', screen !== screenName);
                    }
                });
                this.gameState.currentScreen = screenName;
                
                if (screenName === 'game') {
                    this.updateInputModeUI();
                }
            }

            updateUI() {
                // „É°„Éã„É•„ÉºÁîªÈù¢„ÅÆÁèæÂú®Ë®≠ÂÆöË°®Á§∫
                const modeNames = { katakana: '„Ç´„Çø„Ç´„Éä', hiragana: '„Å≤„Çâ„Åå„Å™', mixed: '„Éü„ÉÉ„ÇØ„Çπ' };
                const difficultyNames = { easy: '„Åã„Çì„Åü„Çì', normal: '„Åµ„Å§„ÅÜ', hard: '„ÇÄ„Åö„Åã„Åó„ÅÑ' };
                
                document.getElementById('currentMode').textContent = modeNames[this.gameState.gameSettings.mode];
                document.getElementById('currentDifficulty').textContent = difficultyNames[this.gameState.gameSettings.difficulty];
                
                // „Ç≤„Éº„É†ÁîªÈù¢UIÊõ¥Êñ∞
                if (this.gameState.currentScreen === 'game') {
                    document.getElementById('score').textContent = this.gameState.gameData.score;
                    document.getElementById('timeLeft').textContent = this.gameState.gameData.timeLeft;
                    
                    const comboElement = document.getElementById('combo');
                    if (this.gameState.gameData.combo > 1) {
                        comboElement.classList.remove('hidden');
                        comboElement.querySelector('span').
